---
title: "Final Project"
author: "Kelsea MacDonald"
date: "2023-03-06"
output: html_document
editor_options: 
  chunk_output_type: console
---
## Background:
  I wanted to find out if lesser yellowleg populations were sensitive to high temperatures The missouri department of conservation states that they may lose nesting ground as the climate warms (https://mdc.mo.gov/discover-nature/field-guide/lesser-yellowlegs). To test a correlation between high temperatures and population size I will compare max temperature data from within the US to a record of lesser yellowlegs populations in the US. 
  The yellowleg data comes from the North American Breeding Bird Survey dataset from the USGS website. They used a method called avian point count, where a single person in a single location counted all of the birds of each species for a fixed amount of time. 
  The temperature data from berkeleyearth is derived from about 19,000 temperature stations across the US from which land surface temperatures were taken and compared to the baseline for that station. The baseline is set as Jan 1951-Dec 1980.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
path <-  "~/Library/CloudStorage/OneDrive-UniversityofCalifornia,Davis/ESP106/esp106-kelsea_macdonald/final project"
#setwd(path)
```

```{r, include=FALSE}
# Read in file:
# URL = "http://berkeleyearth.lbl.gov/auto/Regional/TMAX/Text/california-TMAX-Trend.txt"
# f = file.path("data", basename(URL))
# if (!file.exists(f)) {
#   dir.create("data", FALSE, FALSE)
#   download.file(URL, f, mode="wb")
# }
# This is the file for daily max land temperature anomaly from 1870 to 2019 in the state of California
# Data is split into monthly, annual, 5-year, 10-year, and 20-year anomalies
# Berkeley Earth
```

```{r, scratch, include=FALSE} 
# Scratch work from when I was figuring things out:
#Delete before finishing:
# list.files(path)
# library(terra)
# dailyTMAX60 <- rast("Complete_TMAX_Daily_LatLong1_1960.nc")
# plot(dailyTMAX60)
# dailyTMAX60 is the average max land temperature from 1960 to 1969 for the whole world
## data <- data.frame(strsplit(data[1,1], split = ","), strsplit(data[2:1796,1], split = " "))
# data <- as.matrix(data, ncol=12)
# separate(data) #not working :/

# library(dplyr)
# library(tidyr)
# data <- read.delim(file="california-TMAX-Trend.txt", skip = 68, sep="\t", quote="", comment.char="")
# separate(data, col =1, sep=" ")f = "california-TMAX-Trend.txt"

```

```{r, California temp scratch, include=FALSE}
# Read txt file "f" with first 68 comment lines removed, readLines method
# x = readLines(f)
# x = x[-c(1:68)]
# 
# # read.delim method
# data <- read.delim(file= f, skip=68, header=F)
# # Then set header as the first 2 rows
# hdr = data[1:2,]
# set rest as the data
# d= data[-c(1:3),]
# # turn the multiple spaces into single spaces
# d = stringr::str_squish(d)
# # split the string into separate characters by single space
# y = strsplit(d, " ")
# # bind the strings into rows
# z = do.call(rbind, y)
# # binds the rows into a matrix and changes the variables to numeric
# z = matrix(as.numeric(z), nrow=nrow(z))
# head(z)
# colnames(z) <- c("Year", "Month", "Monthly Anomaly", "Monthly Anomaly Unc", 
#                  "Annual Anomaly", "Annual Anomaly Unc", "Five-year Anomaly", 
#                  "Five-year Anomaly Unc", "Ten-year Anomaly", "Ten-year Anomaly Unc",
#                  "Twenty-year Anomaly", "Twenty-year Anomaly Unc")
# a <- as.data.frame(z)
# colnames(a) <- c("Year", "Month", "Monthly Anomaly", "Monthly Anomaly Unc", 
#                  "Annual Anomaly", "Annual Anomaly Unc", "Five-year Anomaly", 
#                  "Five-year Anomaly Unc", "Ten-year Anomaly", "Ten-year Anomaly Unc",
#                  "Twenty-year Anomaly", "Twenty-year Anomaly Unc")
```

Download avian point count data from sciencebase as a csv:
```{r}
# library(rjson)
# URL.bird = "	https://www.sciencebase.gov/MigrantNonBreeder.zip"
# f.bird = file.path("data", basename(URL.bird))
# if (!file.exists(f.bird)) {
#   download.file(URL.bird, f.bird, mode="wb")
# }

#Make this reproducible later
migrant.sum <- file.path(path, "data", "MigrantNonBreeder", "MigrantSummary.csv")
birds <- read.csv(migrant.sum)
```

From the bird dataset, subset the lesser yellowlegs within the US:
```{r}
# AOU 2550 = lesser yellowlegs
yl <- subset(birds, AOU == 2550)
# 840 = US
us.yl <- subset(yl, CountryNum == 840)
# This limits our data to the years 1992 - 2021
```

There were multiple point counts taken per year, so take the average for each year:
```{r}
mean.yl <- aggregate(SpeciesTotal ~ Year, data=us.yl, FUN=mean)
```

Download temperature anomaly data for the US from berkeleyearth:
```{r}
temp.URL = "http://berkeleyearth.lbl.gov/auto/Regional/TMAX/Text/united-states-TMAX-Trend.txt"
temp.file = file.path("data", basename(temp.URL))
if(!file.exists(temp.file)) {
  dir.create("data", FALSE, FALSE)
  download.file(temp.URL, temp.file, mode="wb")
}
# this dataset gives the anomaly in maximum monthly and annual temperatures for the US
# A more meaningful way to look at the data would be to localize it, but the samples for the lesser yellowlegs were taken all over the US and there was not enough data for any one location
```

The temperature data is a txt file so we need to convert it to a data.frame:
```{r}
r = read.delim(file = temp.file, skip = 67, header = FALSE)
t.hdr = r[1:2,] #this separates the header
t.data.a = r[-c(1:3),] # this is the actual data
t.data.b = stringr::str_squish(t.data.a) #turns multiples spaces into one space
t.data.c = strsplit(t.data.b, " ") #splits the string up so we can create separate columns
t.data.d = do.call(rbind, t.data.c)
t.data.e = matrix(as.numeric(t.data.d), nrow=nrow(t.data.d)) 
# Unc. = uncertainty
colnames(t.data.e) <- c("Year", "Month", "Monthly Anomaly", "Monthly Anomaly Unc", 
                 "Annual Anomaly", "Annual Anomaly Unc", "Five-year Anomaly", 
                 "Five-year Anomaly Unc", "Ten-year Anomaly", "Ten-year Anomaly Unc",
                 "Twenty-year Anomaly", "Twenty-year Anomaly Unc")
t.data.f <- as.data.frame(t.data.e) 
```

Since avian point count data for lesser yellow legs is only available for the years 1992 to 2021, subset temperature data to match this time frame:
```{r}
t.data.g <- subset(t.data.f, Year < 2021 & Year > 1990)
```

We are going to use annual anomalies for our plot, but the annual anomalies are given as averages centered around the corresponding month in the table. In order to only get one value per year, subset only data for the month of June:
```{r}
temp <- subset(t.data.g, Month == 6)
# this is the final table for our temperature data, now we can use it for our plot
```


Merge the two datasets:
```{r}
merg <- merge(temp, mean.yl, by = 'Year') # merged by the common column, "Year"
```

Plots:
```{r}
library(ggplot2)

#first plot = annual max temperature anomaly from 1991 to 2016
# plot(temp$Year, temp$`Annual Anomaly`)
# lm(temp$Year ~ temp$`Annual Anomaly`)
ggplot(data=temp, aes(Year, `Annual Anomaly`))+
  geom_point()+
  geom_line()+
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth")

#second plot = average annual point count of lesser yellowlegs 1991 to 2021
# plot(mean.yl$Year, mean.yl$SpeciesTotal)
# lm(mean.yl$Year ~ mean.yl$SpeciesTotal)
ggplot(data=mean.yl, aes(Year, SpeciesTotal))+
  geom_point()+
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth")

#third plot = correlation between temperature anomaly and yellowleg count
# plot(merg$`Annual Anomaly`, merg$SpeciesTotal)
ggplot(data=merg, aes(`Annual Anomaly`, SpeciesTotal))+
  geom_point()+
  stat_smooth(method = "lm",
              formula = y ~ x,
              geom = "smooth")


lm(merg$`Monthly Anomaly`~ merg$SpeciesTotal)
cor.test(merg$`Monthly Anomaly`, merg$SpeciesTotal)
#p-value indicates that the correlation is significant, however it does not appear very strong and given the limited dataset I used I would take these results with a grain of salt
```
The data does show a weak correlation between temperature and yellowleg count, though in an opposite direction from what I expected. I thought that as temperatures rose, bird count would fall.

However, this paper:(https://onlinelibrary.wiley.com/doi/full/10.1002/ece3.9495) states that "Since the 1970s, the lesser yellowlegs (Tringa flavipes) has experienced a pronounced reduction in abundance of ~63%." My data showed an increase in lesser yellowlegs over the past decade, showing that the avian point count data is likely not a reliable indicator of total species population size. The avian point count data for lesser yellowlegs specifically did not cover as wide of a range of dates as I would have liked, so for the future I may want to find another dataset to represent population size over time.
